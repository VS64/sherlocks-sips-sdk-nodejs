"use strict";function _interopDefault$1(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var hmacSHA256=_interopDefault$1(require("crypto-js/hmac-sha256")),sipsPaymentDom=require("sips-payment-dom"),axios=_interopDefault$1(require("axios")),sha256=_interopDefault$1(require("crypto-js/sha256")),classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},sortAndFilterFunctionsFromEntries=function(e){return e.filter(function(e){return"function"!=typeof e[1]&&void 0!==e[1]&&null!==e[1]}).sort()},concatenate=function e(t,n){var a=t,r=function(e){a+=e};return n instanceof Array?r(n.toString().replace(/,/g,"")):n instanceof Object?sortAndFilterFunctionsFromEntries(Object.entries(n)).forEach(function(t){a=e(a,t[1])}):r(n),a},getSealStringForPaymentRequest=function(e){var t="";return sortAndFilterFunctionsFromEntries(Object.entries(e)).filter(function(e){return"keyVersion"!==e[0]}).forEach(function(e){t=concatenate(t,e[1])}),t},getSealStringForInitializationResponse=function(e){var t="";return sortAndFilterFunctionsFromEntries(Object.entries(e)).filter(function(e){return"seal"!==e[0]}).forEach(function(e){t=concatenate(t,e[1])}),t},SealCalculator=function e(){classCallCheck(this,e)};SealCalculator.getSealString=function(e){return e instanceof sipsPaymentDom.PaymentRequest?getSealStringForPaymentRequest(e):getSealStringForInitializationResponse(e)},SealCalculator.calculateSeal=function(e,t){return hmacSHA256(e,t).toString()};var numberFields=["amount","captureDay"],dateFields=["captureLimitData","transactionDateTime"],mapToResponseData=function(e){return Object.assign.apply(Object,[new sipsPaymentDom.ResponseData].concat(e.map(function(e){var t,n,a,r=e[0],i=e[1];return numberFields.includes(r)?((n={})[r]=Number.parseInt(i,10),n):dateFields.includes(r)?((a={})[r]=Date.parse(i),a):((t={})[r]=i,t)})))},verifyInitializationResponse=function(e,t){if(void 0!==e.seal&&SealCalculator.calculateSeal(SealCalculator.getSealString(e),t)!==e.seal)throw new Error("Initialization response has been tampered with!")},verifyPaypageResponse=function(e,t,n){if(sha256(e+n).toString()!==t)throw new Error("Paypage response has been tampered with!")},PaypageClient=function e(t,n,a,r){var i=this;if(classCallCheck(this,e),this.initializePayment=function(e){if(!(e instanceof sipsPaymentDom.PaymentRequest))throw new Error("Invalid parameter specified");var t=e;return t.merchantId=i.merchantId,t.keyVersion=i.keyVersion,t.seal=SealCalculator.calculateSeal(SealCalculator.getSealString(e),i.secretKey),axios.post(i.environment,JSON.stringify(t),{headers:{"Content-Type":"application/json"}}).then(function(e){var t=Object.assign(new sipsPaymentDom.InitializationResponse,e.data);return verifyInitializationResponse(t,i.secretKey),t})},this.decodeResponse=function(e){var t=e.Data,n=e.Encode,a=e.InterfaceVersion,r=e.Seal;verifyPaypageResponse(t,r,i.secretKey);var o=new sipsPaymentDom.PaypageResponse;o.encode=n,o.interfaceVersion=a,o.seal=r;var s=t.split("|");return s=s.map(function(e){return e.split("=",2)}),o.data=mapToResponseData(s),o},!Object.values(sipsPaymentDom.Environment).includes(t))throw new Error("Invalid environment specified!");if("string"!=typeof n||0===n.length)throw new Error("Invalid merchant ID specified");if("string"!=typeof r||0===r.length)throw new Error("Invalid key specified");this.environment=t,this.merchantId=n,this.keyVersion=a,this.secretKey=r};exports.PaypageClient=PaypageClient,exports.SealCalculator=SealCalculator;
